# This override file adds Caddy reverse proxy with automatic HTTPS/TLS
# To use it:  docker-compose -f docker-compose.yml -f docker-compose.caddy.yml up -d
# Or rename it to docker-compose.override.yml for automatic inclusion

services:
  caddy:
    image: ${CADDY_IMAGE:-caddy:latest}
    container_name: glkvm_caddy
    restart: always
    ports:
      # HTTP for ACME challenges and automatic redirect to HTTPS
      - "80:80"
      # HTTPS for secure access
      - "443:443"
      - "443:443/udp"  # HTTP/3 support
      # HTTP Proxy port (proxied by Caddy with TLS)
      - "10443:10443"
    volumes:
      - ./templates/Caddyfile.template:/tpl/Caddyfile.tmpl:ro
      - ./scripts/docker-entrypoint.sh:/docker-entrypoint.sh:ro
      - caddy_data:/data
      - caddy_config:/config
    environment:
      DOMAIN: ${DOMAIN}
      ACME_EMAIL: ${ACME_EMAIL}
      RTTYS_WEBUI_INTERNAL_PORT: ${RTTYS_WEBUI_INTERNAL_PORT:-8443}
      RTTYS_HTTP_PROXY_INTERNAL_PORT: ${RTTYS_HTTP_PROXY_INTERNAL_PORT:-18443}
    entrypoint: ["/bin/sh", "/docker-entrypoint.sh"]
    command: ["caddy"]
    depends_on:
      - rttys

  # When Caddy is used, rttys uses internal ports that Caddy will proxy to
  # Caddy will handle the HTTPS and proxy to rttys internal ports
  rttys:
    environment:
      # Override ports to use internal ports when behind Caddy
      RTTYS_WEBUI_PORT: ${RTTYS_WEBUI_INTERNAL_PORT:-8443}
      RTTYS_HTTP_PROXY_PORT: ${RTTYS_HTTP_PROXY_INTERNAL_PORT:-18443}
    # Override volumes to include sample certificates for auto-generation
    # When using Caddy, rttys uses auto-generated certs in a named volume
    # Caddy terminates TLS externally, so these are only for rttys internal use
    # Use !override to replace the entire volumes array from docker-compose.yml
    volumes: !override
      - ./templates/rttys.conf.template:/tpl/rttys.conf.tmpl:ro
      - ./scripts/docker-entrypoint.sh:/docker-entrypoint.sh:ro
      - ./templates/sample_cert.pem:/tpl/sample_cert.pem:ro
      - ./templates/sample_key.pem:/tpl/sample_key.pem:ro
      - rttys_certs:/home/certificate
    # Use !override to replace the entire ports array from docker-compose.yml
    # Only expose device connection port; Caddy handles web UI and HTTP proxy ports
    ports: !override
      - "${RTTYS_DEVICE_PORT:-5912}:${RTTYS_DEVICE_PORT:-5912}"

volumes:
  rttys_certs:
    driver: local
  caddy_data:
    driver: local
  caddy_config:
    driver: local
